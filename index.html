<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <!-- 安全防护：禁止右键、禁止F12、打开调试器自动跳转/白屏 -->
<script type="text/javascript">
    (function () {
      // 1. 保留：禁止右键菜单 (防止用户点击“检查”)
      document.addEventListener('contextmenu', e => e.preventDefault());

      // --- 已移除 selectstart 和 copy 的阻止逻辑 ---
      // 现在允许用户使用快捷键 (Ctrl+C / Ctrl+V) 复制粘贴，并允许拖动选择文本
      // 注意：由于禁用了右键，粘贴需通过键盘快捷键完成

      // 2. 保留：禁止快捷键打开开发者工具 (F12, Ctrl+Shift+I, Ctrl+U 等)
      document.onkeydown = function (e) {
        if (e.keyCode === 123 || 
          (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) || 
          (e.ctrlKey && (e.keyCode === 85 || e.keyCode === 83)) || 
          (e.metaKey && (e.keyCode === 85 || e.keyCode === 83))) {
          return false;
        }
      };

      function killPage() {
        document.body.innerHTML = "";
        window.location.replace('about:blank');
      }

      function detectDevTools() {
        const isRealMobile = /Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);
        if (!isRealMobile) {
          const threshold = 160;
          const widthDiff = window.outerWidth - window.innerWidth > threshold;
          const heightDiff = window.outerHeight - window.innerHeight > threshold;
          if (widthDiff || heightDiff) { killPage(); return true; }
        }
        const start = performance.now();
        debugger;
        const end = performance.now();
        if (end - start > 50) { killPage(); return true; }
        return false;
      }
      
      setInterval(detectDevTools, 1000);
      window.addEventListener('resize', detectDevTools);
      window.addEventListener('load', detectDevTools);
    })();
  </script>
  <!-- 结束安全防护：禁止右键、禁止F12、打开调试器自动跳转/白屏 -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Checkout - Secure Payment Gateway</title>
  <style>
    /* === 基础重置 === */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #fff;
      color: #333;
      margin: 0;
      padding: 0;
      -webkit-font-smoothing: antialiased;
    }

    * {
      box-sizing: border-box;
    }

    .main-container {
      display: flex;
      flex-wrap: wrap;
      max-width: 1100px;
      margin: 0 auto;
      min-height: 100vh;
    }

    /* === 左侧表单区域 === */
    .form-section {
      flex: 1.2;
      padding: 40px;
      background: #fff;
      min-width: 350px;
      border-right: 1px solid #e1e1e1;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin: 35px 0 15px 0;
      padding-bottom: 10px;
      color: #333;
    }

    .section-title:first-child {
      margin-top: 0;
    }

    .input-group {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }

    .input-box {
      flex: 1;
      margin-bottom: 12px;
    }

    label.field-label {
      display: block;
      font-size: 13px;
      color: #555;
      margin-bottom: 6px;
      font-weight: 500;
    }

    input,
    select {
      width: 100%;
      padding: 13px;
      border: 1px solid #d9d9d9;
      border-radius: 5px;
      font-size: 14px;
      transition: all 0.2s;
      background: #fff;
      color: #333;
    }

    input:focus,
    select:focus {
      border-color: #2b5ef8;
      outline: none;
      box-shadow: 0 0 0 1px #2b5ef8;
    }

    /* === 支付方式列表 === */
    .payment-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 15px;
    }

    .payment-option {
      display: flex;
      align-items: center;
      padding: 18px 15px;
      background: #f4f4f4;
      border: 1px solid transparent;
      border-left: 5px solid transparent;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .payment-option:hover {
      background: #e9e9e9;
    }

    .payment-option.selected {
      background-color: #F9FDFA;
      border-left-color: #2b5ef8;
    }

    .payment-option input[type="radio"] {
      width: 18px;
      height: 18px;
      margin-right: 15px;
      accent-color: #2b5ef8;
      cursor: pointer;
    }

    .payment-name {
      font-size: 15px;
      font-weight: 500;
      color: #333;
      flex: 1;
    }

    .payment-icon {
      max-height: 24px;
      width: auto;
      max-width: 200px;
      object-fit: contain;
      margin-left: 10px;
      vertical-align: middle;
      image-rendering: -webkit-optimize-contrast;
    }

    /* === 运费选择器 === */
    .shipping-method-item {
      display: flex;
      align-items: center;
      padding: 15px;
      border: 1px solid #d9d9d9;
      border-radius: 5px;
      margin-bottom: 10px;
      cursor: pointer;
    }

    .shipping-method-item.selected {
      border-color: #2b5ef8;
      background-color: #f9fdfa;
    }

    .shipping-method-item input {
      margin-right: 15px;
      width: auto;
      accent-color: #2b5ef8;
    }

    /* === 摘要区域 === */
    .summary-section {
      flex: 0.8;
      background: #fafafa;
      min-width: 320px;
      border-left: 1px solid #e1e1e1;
      padding: 40px;
    }

    .mobile-summary-toggle {
      display: none;
      background: #fafafa;
      border-bottom: 1px solid #e1e1e1;
      border-top: 1px solid #e1e1e1;
      padding: 18px 20px;
      cursor: pointer;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }

    .toggle-left {
      display: flex;
      align-items: center;
      color: #197bbd;
      font-size: 14px;
      font-weight: 500;
    }

    .toggle-left svg {
      fill: #197bbd;
      margin-right: 8px;
      width: 14px;
      height: 14px;
    }

    .toggle-chevron {
      margin-left: 6px;
      transition: transform 0.3s ease;
    }

    .toggle-total {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    .mobile-summary-toggle.expanded .toggle-chevron {
      transform: rotate(180deg);
    }

    .summary-content {
      display: block;
    }

    .product-list {
      margin-bottom: 20px;
      margin-top: 10px;
    }

    .product-item {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .product-img-wrapper {
      position: relative;
      margin-right: 15px;
    }

    .product-img {
      width: 64px;
      height: 64px;
      background: #fff;
      border: 1px solid #e1e1e1;
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .product-img img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .product-qty-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #727272;
      opacity: 0.9;
      color: #fff;
      font-size: 12px;
      font-weight: 500;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }

    .product-info {
      flex: 1;
      font-size: 14px;
      color: #333;
      font-weight: 500;
      line-height: 1.4;
    }

    .product-variant {
      font-size: 12px;
      color: #717171;
      font-weight: 400;
    }

    .product-price {
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }

    .summary-line {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      font-size: 14px;
      color: #555;
    }

    .total-line {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e1e1e1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .total-label {
      font-size: 16px;
      font-weight: 500;
    }

    .total-price {
      font-size: 24px;
      font-weight: 600;
      color: #333;
      letter-spacing: -0.5px;
    }

    .currency-tag {
      font-size: 12px;
      color: #717171;
      margin-left: 5px;
      font-weight: 400;
      vertical-align: middle;
    }

    /* 按钮样式 */
    button#submit-btn {
      width: 100%;
      padding: 18px;
      background: #3e6cf5;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      margin-top: 30px;
    }

    button#submit-btn:hover {
      background: #1650FF;
    }

    button#submit-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* === 翻译选择器样式 (新增加) === */
    .lang-switcher-wrapper {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-bottom: 15px;
    }

    .lang-switcher-wrapper select {
      width: auto;
      padding: 6px 10px;
      font-size: 13px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      cursor: pointer;
      background: #fff;
    }

    .pc-lang-switcher {
      margin-top: 25px;
      border-top: 1px solid #e1e1e1;
      padding-top: 15px;
    }

    /* === 遮罩层 (保持 V56.0) === */
    #wcr-a-payment-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 10000000;
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(3px);
    }

    .wcr-a-loader-content {
      background: #ffffff;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 90%;
      width: 340px;
      text-align: center;
    }

    .wcr-a-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2ecc71;
      border-radius: 50%;
      animation: wcr-a-spin 0.3s linear infinite;
      margin-bottom: 20px;
    }

    .wcr-a-text {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      font-size: 16px;
      color: #333;
      font-weight: 500;
      line-height: 1.5;
    }

    @keyframes wcr-a-spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* === 移动端适配 === */
    @media (max-width: 900px) {
      .main-container {
        flex-direction: column-reverse;
      }

      .form-section {
        padding: 20px;
        border-right: none;
      }

      .summary-section {
        padding: 0;
        background: #fafafa;
        border-left: none;
        width: 100%;
        position: sticky;
        top: 0;
        z-index: 999;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      }

      .mobile-summary-toggle {
        display: flex;
      }

      .summary-content {
        display: none;
        padding: 20px;
        border-bottom: 1px solid #e1e1e1;
        max-height: 60vh;
        overflow-y: auto;
      }

      .summary-content.show {
        display: block;
        animation: slideDown 0.3s ease-out;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .pc-lang-switcher {
        display: none;
      }
    }

    @media (min-width: 901px) {
      .mobile-lang-switcher {
        display: none;
      }
    }

    .trust-badges {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 25px;
      margin-top: 20px;
      margin-bottom: 10px;
    }

    .trust-badges img {
      height: 40px;
      width: auto;
      object-fit: contain;
      opacity: 0.9;
      transition: opacity 0.2s;
    }

    .trust-badges img:hover {
      opacity: 1;
    }

/* ============================================================
   优惠券与自动折扣增强样式 (包含第一步和第二步的所有样式)
   ============================================================ */

/* 1. 优惠券输入框区域 */
.discount-input-wrapper {
  display: flex;
  gap: 10px;
  margin: 20px 0;
}
.discount-input-wrapper input {
  flex: 1;
  margin-bottom: 0 !important; /* 强制对齐 */
}
.btn-apply {
  padding: 0 20px;
  background: #f1f1f1;
  border: 1px solid #d9d9d9;
  border-radius: 5px;
  cursor: pointer;
  font-weight: 500;
  color: #333;
  transition: background 0.2s;
}
.btn-apply:hover { background: #e5e5e5; }

/* 2. 已应用的优惠券标签 (带 X 号) */
.applied-coupon-tag {
  display: inline-flex;
  align-items: center;
  background: #f1f1f1;
  padding: 6px 10px;
  border-radius: 4px;
  font-size: 13px;
  color: #333;
  margin-bottom: 15px;
}
.coupon-icon {
  margin-right: 6px;
  width: 14px;
  height: 14px;
  fill: #717171;
}
.remove-coupon {
  margin-left: 8px;
  cursor: pointer;
  color: #717171;
  font-weight: bold;
}

/* 3. 商品价格划线与高亮 (还原 Shopify 效果) */
.price-original {
  text-decoration: line-through;
  color: #717171;
  font-size: 12px;
  margin-right: 5px;
}
.price-current {
  color: #333;
  font-weight: 600;
}

/* 4. 商品名称下方的折扣详情小标签 */
.product-discount-badge {
  display: flex;
  align-items: center;
  font-size: 12px;
  color: #717171;
  margin-top: 5px;
  text-transform: uppercase;
  font-weight: 500;
}
.product-discount-badge svg {
  width: 14px;
  height: 14px;
  fill: #717171;
  margin-right: 4px;
}

/* 5. 底部总节省 (TOTAL SAVINGS) 区域 */
.savings-summary {
  margin-top: 15px;
  padding: 10px 0;
  display: none; /* 有优惠时由 JS 控制显示 */
  align-items: center;
  font-weight: 600;
  font-size: 15px;
  color: #333;
}
.savings-summary svg {
  width: 18px;
  height: 18px;
  margin-right: 8px;
}


  </style>
</head>

<body>

  <div class="main-container">
    <!-- 左侧输入表单 -->
    <div class="form-section">
      <!-- 移动端：翻译按钮在最顶端 -->
      <div class="lang-switcher-wrapper mobile-lang-switcher">
        <select class="lang-selector">
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="ko">한국어</option>
          <option value="zh-TW">繁體中文</option>
        </select>
      </div>

      <form id="payment-form">
        <div class="section-title" data-i18n="title_contact">Contact</div>
        <div class="input-box">
          <label class="field-label" data-i18n="label_email">Email Address</label>
          <input type="email" id="email" required placeholder="email@example.com">
        </div>
        <div class="input-box">
          <label class="field-label" data-i18n="label_phone">Phone</label>
          <input type="tel" id="phone" required placeholder="Phone">
        </div>

        <div class="section-title" data-i18n="title_shipping">Shipping Address</div>
        <div class="input-box">
          <label class="field-label" data-i18n="label_country">Country/Region</label>
          <select id="country" required>
            <option value="" disabled selected data-i18n="select_country">Select Country/Region</option>
          </select>
        </div>

        <div class="input-group">
          <div class="input-box">
            <label class="field-label" data-i18n="label_fname">First Name</label>
            <input type="text" id="fname" required>
          </div>
          <div class="input-box">
            <label class="field-label" data-i18n="label_lname">Last Name</label>
            <input type="text" id="lname" required>
          </div>
        </div>

        <div class="input-box">
          <label class="field-label" data-i18n="label_address">Address</label>
          <input type="text" id="address" required placeholder="Street, House No.">
        </div>

        <div class="input-group">
          <div class="input-box">
            <label class="field-label" data-i18n="label_city">City</label>
            <input type="text" id="city" required>
          </div>
          <div class="input-box">
            <label class="field-label" data-i18n="label_state">State / Province</label>
            <input type="text" id="state" required>
          </div>
          <div class="input-box">
            <label class="field-label" data-i18n="label_zip">ZIP Code</label>
            <input type="text" id="zip" required>
          </div>
        </div>

        <div id="shipping-method-area" style="display:none;">
          <div class="section-title" data-i18n="title_shipping_method">Shipping Method</div>
          <div id="shipping-rates-list"></div>
        </div>

        <div class="section-title" data-i18n="title_payment">Payment Method</div>
        <div id="payment-container" class="payment-list">
          <div style="padding:15px; color:#666; font-size:14px;">Loading payment options...</div>
        </div>
        <input type="hidden" id="gateway" required>

        <button type="submit" id="submit-btn" data-i18n="btn_place_order">PLACE ORDER</button>

        <div class="trust-badges">
          <img src="https://image.defitopay.com/worldgate.svg" alt="Secured by WorldGate">
          <img src="https://image.defitopay.com/pci.svg" alt="PCI DSS Compliant">
        </div>

        <div
          style="margin-top:12px; text-align: center; font-weight: bold; font-size: 11px; color:#bbb; font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
          Copyright 2026 Worldpay LLC, and its affiliates.
        </div>
      </form>
    </div>

    <!-- 右侧订单摘要 -->
    <div class="summary-section">
      <div class="mobile-summary-toggle" id="summaryToggle">
        <div class="toggle-left">
          <svg viewBox="0 0 20 20">
            <path
              d="M17.178 13.088H5.453c-.454 0-.91-.364-.908-.82l.148-4.408c.002-.455.463-.82.914-.82h11.569c.454 0 .91.364.908.82l-.148 4.408c-.002.455-.463.82-.914.82zm3.427-12.35l-1.659 7.902c-.244 1.163-1.554 2.14-2.84 2.14l-1.07.001c-.002.502-.005 1.004-.007 1.505 0 1.256-1.015 2.275-2.268 2.275-1.252 0-2.268-1.02-2.268-2.275 0-.501.005-1.003.007-1.505l-3.32.003c.003.502.006 1.004.008 1.505 0 1.256-1.015 2.275-2.268 2.275-1.252 0-2.268-1.02-2.268-2.275 0-.501.004-1.003.007-1.505L.804 5.672C.555 4.54.167 2.663.072 2.185.02 1.926-.01 1.696.002 1.507.037.95.342.602.83.602h2.23c.84 0 1.631.542 1.928 1.32L5.89 4.39c.603 0 1.206-.002 1.808-.002V2.85c0-1.57 1.27-2.848 2.835-2.848 1.566 0 2.836 1.278 2.836 2.849v1.538c.602 0 1.204.002 1.806.002l.745-2.12c.26-.74.966-1.268 1.76-1.268h2.09c.49 0 .807.36.852.92.02.247.01.536-.068.818zM11.69 2.85c0-.907-.733-1.642-1.637-1.642-.903 0-1.637.735-1.637 1.642v1.54h3.273V2.85z">
            </path>
          </svg>
          <span id="toggleText" data-i18n="toggle_show">Show order summary</span>
          <svg class="toggle-chevron" viewBox="0 0 10 7"
            style="width:10px; height:7px; fill:none; stroke:#197bbd; stroke-width:2px;">
            <path d="M1 1L5 5L9 1" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </div>
        <div class="toggle-total" id="mobile-total-display">$0.00</div>
      </div>

      <div class="summary-content" id="summaryContent">
        <div id="product-list" class="product-list"></div>
        <!-- 1. 优惠券输入框 -->
        <div class="discount-input-wrapper">
          <input type="text" id="coupon-input" placeholder="Discount code or gift card">
          <button type="button" class="btn-apply" id="apply-coupon-btn" onclick="applyDiscount()">Apply</button>
        </div>

        <!-- 2. 已应用标签 -->
        <div id="coupon-tag-area" style="display:none;">
           <div class="applied-coupon-tag">
             <svg class="coupon-icon" viewBox="0 0 16 16"><path d="M16 8c0 .28-.22.5-.5.5h-2.1c-.28 0-.5-.22-.5-.5s.22-.5.5-.5h2.1c.28 0 .5.22.5.5zm-5.41-3.41L12 3.17c.2-.2.2-.51 0-.71-.2-.2-.51-.2-.71 0L9.88 3.88c-.2.2-.2.51 0 .71.2.2.51.2.71 0zM4 12h8v2H4v-2zm0-3h8v2H4V9zm0-3h8v2H4V6zm10.71-3.71c-.2-.2-.51-.2-.71 0L12.59 3.7c-.2.2-.2.51 0 .71.2.2.51.2.71 0l1.41-1.41c.2-.2.2-.51 0-.71zM15 8c0-3.87-3.13-7-7-7S1 4.13 1 8s3.13 7 7 7 7-3.13 7-7zM8 2c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6 2.69-6 6-6z"/></svg>
             <span id="applied-code-text">TEST888</span>
             <span class="remove-coupon" onclick="removeDiscount()">✕</span>
           </div>
        </div>

        <div class="summary-line"><span data-i18n="summary_subtotal">Subtotal</span><span id="subtotal-val">0.00</span></div>
        
        <!-- 3. 折扣行 -->
        <div class="summary-line discount-line" id="discount-row">
          <div style="display:flex; flex-direction:column;">
            <span>Order discount</span>
            <span style="font-size:12px; color:#717171;" id="discount-detail-text"></span>
          </div>
          <span id="discount-val">- 0.00</span>
        </div>

        <div class="summary-line"><span data-i18n="summary_shipping">Shipping</span><span id="shipping-display" data-i18n="summary_calc">Calculated at next step</span></div>
        
        <div class="total-line">
          <span class="total-label" data-i18n="summary_total">Total</span>
          <div style="display:flex; align-items:baseline;">
            <span class="currency-tag" id="currency-tag">USD</span>
            <span id="total-val" class="total-price">0.00</span>
          </div>
        </div>

        <!-- 4. Total Savings 模块 -->
        <div class="savings-box" id="savings-box">
          <svg viewBox="0 0 16 16"><path d="M16 8c0 .28-.22.5-.5.5h-2.1c-.28 0-.5-.22-.5-.5s.22-.5.5-.5h2.1c.28 0 .5.22.5.5zm-5.41-3.41L12 3.17c.2-.2.2-.51 0-.71-.2-.2-.51-.2-.71 0L9.88 3.88c-.2.2-.2.51 0 .71.2.2.51.2.71 0zM4 12h8v2H4v-2zm0-3h8v2H4V9zm0-3h8v2H4V6zm10.71-3.71c-.2-.2-.51-.2-.71 0L12.59 3.7c-.2.2-.2.51 0 .71.2.2.51.2.71 0l1.41-1.41c.2-.2.2-.51 0-.71zM15 8c0-3.87-3.13-7-7-7S1 4.13 1 8s3.13 7 7 7 7-3.13 7-7zM8 2c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6 2.69-6 6-6z"/></svg>
          <span>TOTAL SAVINGS  <span id="savings-val">0.00</span></span>
        </div>

        <!-- PC端：翻译按钮在摘要最下方 -->
        <div class="lang-switcher-wrapper pc-lang-switcher">
          <select class="lang-selector">
            <option value="en">English</option>
            <option value="ja">日本語</option>
            <option value="ko">한국어</option>
            <option value="zh-TW">繁體中文</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div id="wcr-a-payment-loader">
    <div class="wcr-a-loader-content">
      <div class="wcr-a-spinner"></div>
      <div class="wcr-a-text">
        <div class="main-msg" data-i18n="mask_main">Securely launching payment</div>
        <div class="sub-msg" style="font-size: 14px; color: #2ecc71; font-weight: normal;" data-i18n="mask_sub">
          Please do not exit or close this window
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // 多语言核心逻辑 (新增加)
    // ==========================================
    async function applyLanguage(lang) {
      const CLOUDFLARE_BASE_URL = 'https://worldpay-shopify-to-wordpress-ant-live.pages.dev'; 
      
      try {
        const cacheBuster = new Date().getTime();
        const url = `${CLOUDFLARE_BASE_URL}/translate/${lang}.json?v=${cacheBuster}`;
        
        const res = await fetch(url);
        if (!res.ok) return;

        const trans = await res.json();

        // 1. 翻译带有 data-i18n 属性的文本
        document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.getAttribute('data-i18n');
          if (trans[key]) el.textContent = trans[key];
        });

        // 2. 翻译输入框提示 (Placeholder)
        const placeholders = {
          'email': 'placeholder_email',
          'address': 'placeholder_address',
          'phone': 'placeholder_phone'
        };
        for (let id in placeholders) {
          const el = document.getElementById(id);
          if (el && trans[placeholders[id]]) el.placeholder = trans[placeholders[id]];
        }

        // 3. 同步所有下拉选择器的状态并保存偏好
        document.querySelectorAll('.lang-selector').forEach(s => s.value = lang);
        localStorage.setItem('preferred_lang', lang);

      } catch (e) {
        // 生产环境仅保留必要的错误记录，不打印调试信息
        console.error('i18n error');
      }
    }

    /**
     * 绑定下拉框切换事件
     */
    function bindLangEvents() {
      document.querySelectorAll('.lang-selector').forEach(select => {
        select.onchange = (e) => applyLanguage(e.target.value);
      });
    }

    /**
     * 页面加载初始化
     */
    window.addEventListener('DOMContentLoaded', () => {
      bindLangEvents();

      const saved = localStorage.getItem('preferred_lang');
      const browser = navigator.language.split('-')[0];
      
      // 优先级：手动选择 > 浏览器识别 > 英语
      const target = saved || (browser === 'zh' ? 'zh-TW' : (['ja','ko'].includes(browser) ? browser : 'en'));
      
      applyLanguage(target);
    });

// === 优惠券全局状态 ===
    let currentDiscount = {
      code: "",
      type: "none", // percentage, fixed_amount, buy_x_get_y
      value: 0,
      amount: 0
    };

    // 模拟从后台同步的优惠券配置信息 (实际应用中你可以通过 fetch 调用后台接口获取)
    async function validateCouponFromBackend(code) {
      // 此处演示逻辑：你可以根据代码前缀模拟不同场景
      // 场景1：固定比例 (TEST10 -> 10% off)
      if (code.toUpperCase().startsWith("TEST10")) return { type: "percentage", value: 0.1, code: code.toUpperCase() };
      // 场景2：固定金额 (SAVE5 -> 减5元)
      if (code.toUpperCase().startsWith("SAVE5")) return { type: "fixed_amount", value: 5.0, code: code.toUpperCase() };
      // 场景3：满减/满件 (满2件打9折)
      if (code.toUpperCase().startsWith("BUY2")) return { type: "buy_x_min", min_qty: 2, value: 0.1, code: code.toUpperCase() };
      
      // 默认通配
      if (code.length >= 3) return { type: "percentage", value: 0.1, code: code.toUpperCase() }; 
      return null;
    }

    // 处理手动输入优惠券：通过 Shopify 路径应用，由 Shopify 后台校验
    window.applyDiscount = async function() {
      const code = document.getElementById('coupon-input').value.trim();
      if (!code) return;

      const btn = document.getElementById('apply-coupon-btn');
      btn.innerText = "Checking...";

      try {
        // 关键：将优惠券发送到 Shopify 的折扣处理接口
        // 这会让 Shopify 后台执行冲突检查（自动折扣 vs 优惠码）
        await fetch(`/discount/${code}`);
        
        // 重新加载购物车数据，看看 Shopify 后台最终决定应用哪个折扣
        await loadCartData();
        
        document.getElementById('coupon-input').value = "";
      } catch (e) {
        alert("Apply discount failed");
      } finally {
        btn.innerText = "Apply";
      }
    };


    window.removeDiscount = function() {
      currentDiscount = { code: "", type: "none", value: 0, amount: 0 };
      document.getElementById('coupon-tag-area').style.display = 'none';
      document.getElementById('discount-row').style.display = 'none';
      document.getElementById('savings-box').style.display = 'none';
      updateTotalDisplay();
    };

    // ==========================================
    // V56.0 原始功能逻辑 (保持不变)
    // ==========================================
    function showWcrLoading() { document.getElementById('wcr-a-payment-loader').style.display = 'flex'; }
    function hideWcrLoading() { document.getElementById('wcr-a-payment-loader').style.display = 'none'; }

    const shopifyOption = { id: 'shopify_checkout', name: 'Shopify Secure Checkout', icon: 'https://image.defitopay.com/global_pay.svg' };
    const currencyPaymentMap = {
      'USD': [shopifyOption],
      'JPY': [{ id: 'paypay', name: 'PayPay', icon: 'https://image.defitopay.com/paypay.svg' }, 
              { id: 'aupay', name: 'au Pay', icon: 'https://image.defitopay.com/aupay.svg' }, shopifyOption],
      'KRW': [{ id: 'kakaopay', name: 'KakaoPay', icon: 'https://image.defitopay.com/kakaopay.png' }, 
              { id: 'tosspay', name: 'Toss Pay', icon: 'https://image.defitopay.com/tosspay.png' }, 
              { id: 'naverpay', name: 'Naver Pay', icon: 'https://image.defitopay.com/naverpay.png' }, 
              { id: 'payco', name: 'Naver Pay', icon: 'https://image.defitopay.com/payco.png' }, shopifyOption],
      'TWD': [{ id: 'jkopay', name: 'JKOPay', icon: 'https://image.defitopay.com/tw_jkopay.png' }, shopifyOption],
      'CNY': [shopifyOption],
      'DEFAULT': [shopifyOption]
    };

    const allCountries = [{ code: "US", name: "United States" }, { code: "JP", name: "日本国" }, { code: "KR", name: "대한민국" }, { code: "TW", name: "Taiwan" }, { code: "HK", name: "Hong Kong" }, { code: "SG", name: "Singapore" }, { code: "MY", name: "Malaysia" }, { code: "GB", name: "United Kingdom" }, { code: "CA", name: "Canada" }, { code: "AU", name: "Australia" }];
    let currentCart = null, availableShippingRates = [], selectedShippingRate = null;

    function initCountries() {
      const select = document.getElementById('country');
      allCountries.forEach(c => { const option = document.createElement('option'); option.value = c.code; option.innerText = c.name; select.appendChild(option); });
    }

    function renderPaymentMethods(currency) {
      const container = document.getElementById('payment-container');
      const methods = currencyPaymentMap[currency] || currencyPaymentMap['DEFAULT'];
      let html = '';
      methods.forEach((m, index) => {
        const isChecked = index === 0; if (isChecked) document.getElementById('gateway').value = m.id;
        html += `<label class="payment-option ${isChecked ? 'selected' : ''}" onclick="selectPayment(this, '${m.id}')"><input type="radio" name="payment_method_radio" ${isChecked ? 'checked' : ''}><div class="payment-name">${m.name}</div><img src="${m.icon}" alt="${m.name}" class="payment-icon"></label>`;
      });
      container.innerHTML = html;
    }

    window.selectPayment = function (el, gatewayId) {
      document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
      el.classList.add('selected'); el.querySelector('input').checked = true;
      document.getElementById('gateway').value = gatewayId;
    };

    const summaryToggle = document.getElementById('summaryToggle');
    const summaryContent = document.getElementById('summaryContent');
    summaryToggle.addEventListener('click', () => { summaryContent.classList.toggle('show'); summaryToggle.classList.toggle('expanded'); });

    async function loadCartData() {
      try {
        // 1. 获取 Shopify 最新的购物车状态
        const res = await fetch('/cart.js');
        currentCart = await res.json();
        
        // 2. 提取订单级别的折扣应用 (例如自动折扣规则名称)
        currentAppliedDiscounts = currentCart.cart_level_discount_applications || [];
        
        // 3. 渲染页面
        document.getElementById('currency-tag').innerText = currentCart.currency;
        renderPaymentMethods(currentCart.currency); 
        updateTotalDisplay();
      } catch (err) {
        console.error("Failed to load shopify cart data", err);
      }
    }

    async function fetchShippingRates() {
      const country = document.getElementById('country').value, province = document.getElementById('state').value, zip = document.getElementById('zip').value;
      if (!zip || zip.length < 3 || !country) return;
      const listDiv = document.getElementById('shipping-rates-list');
      document.getElementById('shipping-method-area').style.display = 'block';
      listDiv.innerHTML = "<div style='padding:10px; color:#666;'>Calculating rates...</div>";
      try {
        const query = `shipping_address[zip]=${encodeURIComponent(zip)}&shipping_address[country]=${encodeURIComponent(country)}&shipping_address[province]=${encodeURIComponent(province)}`;
        const res = await fetch(`/cart/shipping_rates.json?${query}`);
        const data = await res.json(); availableShippingRates = data.shipping_rates;
        if (availableShippingRates && availableShippingRates.length > 0) {
          let html = '';
          availableShippingRates.forEach((rate, index) => {
            if (index === 0) selectedShippingRate = rate;
            html += `<div class="shipping-method-item ${index === 0 ? 'selected' : ''}" id="ship-box-${index}" onclick="selectShipping(${index})"><input type="radio" name="s_rate" id="r-${index}" ${index === 0 ? 'checked' : ''}><div style="flex:1;">${rate.name}</div><div style="font-weight:bold;">${rate.price} ${currentCart.currency}</div></div>`;
          });
          listDiv.innerHTML = html; updateTotalDisplay();
        }
      } catch (err) { }
    }

    window.selectShipping = function (index) {
      document.querySelectorAll('.shipping-method-item').forEach(el => el.classList.remove('selected'));
      document.getElementById(`ship-box-${index}`).classList.add('selected');
      selectedShippingRate = availableShippingRates[index]; updateTotalDisplay();
    };

    function updateTotalDisplay() {
      if (!currentCart) return;
      
      const currency = currentCart.currency;
      let totalSavings = 0;
      let productHtml = '';

      // 1. 遍历商品，渲染行项目折扣 (Shopify 自动计算的结果)
      currentCart.items.forEach(item => {
        const originalLinePrice = item.original_line_price / 100;
        const finalLinePrice = item.final_line_price / 100;
        const itemDiscount = originalLinePrice - finalLinePrice;
        totalSavings += itemDiscount;

        // 获取该商品应用的具体折扣名称 (如果有)
        let discountBadges = '';
        if (item.line_level_discount_allocations && item.line_level_discount_allocations.length > 0) {
          item.line_level_discount_allocations.forEach(disc => {
            // 这里 disc.discount_application.title 是 Shopify 后台配置的真实名称
            discountBadges += `
              <div class="product-discount-badge">
                <svg viewBox="0 0 16 16"><path d="M16 8c0 .28-.22.5-.5.5h-2.1c-.28 0-.5-.22-.5-.5s.22-.5.5-.5h2.1c.28 0 .5.22.5.5zm-5.41-3.41L12 3.17c.2-.2.2-.51 0-.71-.2-.2-.51-.2-.71 0L9.88 3.88c-.2.2-.2.51 0 .71.2.2.51.2.71 0zM4 12h8v2H4v-2zm0-3h8v2H4V9zm0-3h8v2H4V6zm10.71-3.71c-.2-.2-.51-.2-.71 0L12.59 3.7c-.2.2-.2.51 0 .71.2.2.51.2.71 0l1.41-1.41c.2-.2.2-.51 0-.71zM15 8c0-3.87-3.13-7-7-7S1 4.13 1 8s3.13 7 7 7 7-3.13 7-7zM8 2c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6 2.69-6 6-6z"/></svg>
                ${disc.discount_application.title} (-${(disc.amount/100).toFixed(2)} ${currency})
              </div>`;
          });
        }

        productHtml += `
          <div class="product-item">
            <div class="product-img-wrapper">
              <div class="product-img"><img src="${item.image}"></div>
              <div class="product-qty-badge">${item.quantity}</div>
            </div>
            <div class="product-info">
              <div style="font-weight:500;">${item.product_title}</div>
              <div class="product-variant">${item.variant_title || ''}</div>
              ${discountBadges}
            </div>
            <div class="product-price">
              ${itemDiscount > 0 ? `<span class="price-original">${originalLinePrice.toFixed(2)} ${currency}</span>` : ''}
              <span class="price-current">${finalLinePrice.toFixed(2)} ${currency}</span>
            </div>
          </div>`;
      });

      document.getElementById('product-list').innerHTML = productHtml;

      // 2. 渲染底部金额总计
      const subtotal = currentCart.original_total_price / 100;
      const shippingPrice = selectedShippingRate ? parseFloat(selectedShippingRate.price) : 0;
      
      // 注意：currentCart.total_price 已经是 Shopify 计算过所有折扣后的最终价了
      const finalPrice = (currentCart.total_price / 100) + shippingPrice;

      document.getElementById('subtotal-val').innerText = (currentCart.total_price / 100).toFixed(2) + " " + currency;
      
      // TOTAL SAVINGS 展示
      const savingsBox = document.getElementById('savings-summary-box');
      if (totalSavings > 0) {
        savingsBox.style.display = 'flex';
        document.getElementById('total-savings-val').innerText = totalSavings.toFixed(2) + " " + currency;
      } else {
        savingsBox.style.display = 'none';
      }

      document.getElementById('total-val').innerText = finalPrice.toFixed(2);
      document.getElementById('mobile-total-display').innerText = finalPrice.toFixed(2) + " " + currency;
      
      // 记录要传给中台的信息
      window.finalPayAmount = finalPrice.toFixed(2);
      
      // 获取折扣标题（取第一个应用的折扣名称透传）
      window.mainDiscountTitle = currentAppliedDiscounts.length > 0 ? currentAppliedDiscounts[0].title : "";
      window.totalDiscountAmount = totalSavings.toFixed(2);
    }

    initCountries(); loadCartData();
    ['zip', 'state', 'country'].forEach(id => document.getElementById(id).addEventListener('change', fetchShippingRates));

    document.getElementById('payment-form').onsubmit = async (e) => {
      e.preventDefault();
      const btn = document.getElementById('submit-btn');
      const gatewayVal = document.getElementById('gateway').value;
      if (!gatewayVal) return;
      showWcrLoading();

      if (gatewayVal === 'shopify_checkout') {
        const params = new URLSearchParams();
        const fields = { 'checkout[email]': 'email', 'checkout[shipping_address][first_name]': 'fname', 'checkout[shipping_address][last_name]': 'lname', 'checkout[shipping_address][address1]': 'address', 'checkout[shipping_address][city]': 'city', 'checkout[shipping_address][country]': 'country', 'checkout[shipping_address][province]': 'state', 'checkout[shipping_address][zip]': 'zip', 'checkout[shipping_address][phone]': 'phone' };
        for (let key in fields) { params.append(key, document.getElementById(fields[key]).value); }
        window.top.location.href = '/checkout?' + params.toString();
        return;
      }

      btn.disabled = true;
      const payload = {
        order_id: "SH-" + Date.now() + Math.floor(Math.random() * 1000000).toString().padStart(6, '0'), 
        total_amount: window.finalPayAmount, 
        currency: currentCart.currency, 
        // 这里透传的是从 Shopify Cart API 拿到的真实折扣名称和金额
        discount_code: window.mainDiscountTitle, 
        discount_amount: window.totalDiscountAmount,
        gateway_mask: gatewayVal, 
        origin_domain: window.location.host, 
        return_url: window.location.origin + "/pages/thank-you",
        discount_code: currentDiscount.code,
        discount_amount: currentDiscount.amount,
        hook_url: "https://test-pay.defitopay.com/api/v2/an/status-update", line_items: currentCart.items.map(item => ({ variant_id: item.variant_id, quantity: item.quantity, title: item.title, price: (item.price / 100).toFixed(2) })), shipping_lines: selectedShippingRate ? [{ title: selectedShippingRate.name, price: selectedShippingRate.price }] : [], 
        billing: { email: document.getElementById('email').value, phone: document.getElementById('phone').value, first_name: document.getElementById('fname').value, last_name: document.getElementById('lname').value, address1: document.getElementById('address').value, city: document.getElementById('city').value, state: document.getElementById('state').value, postcode: document.getElementById('zip').value, country: document.getElementById('country').value, province: document.getElementById('state').value, zip: document.getElementById('zip').value }
      };
      const _p = "TUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGRERGUThBTUlJQkNnS0NBUUVBb0RPWG1wU0FZelNERjNKdSthRUhabVJSdk5XRDZDQ0N3dVVMUW1kR0pnb0pqV1d4Ym1hQQ==";
      const _s = "TUlJRXZRSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2N3Z2dTakFnRUFBb0lCQVFESC96Mkp0amRjNDdMQm11eFJLTmhsbENQQUZscEI0SGhpbkV5MFRnRUtUZUJaKzZxVkJrMmMxaGJqVWFYUXdkZ0R3UTRTMEo=";

      try {
        const response = await fetch('https://test-pay.defitopay.com/v1/an/checkout', { method: 'POST', headers: { 'Content-Type': 'application/json', 'worldpay_public_key': atob(_p), 'cus_secret_key': atob(_s), 'X-Customer-Language': navigator.language }, body: JSON.stringify(payload) });
        const result = await response.json();
        if (result.pay_url) { window.top.location.href = result.pay_url; }
        else { hideWcrLoading(); alert("Error: " + result.message); btn.disabled = false; }
      } catch (err) { hideWcrLoading(); alert("System Error."); btn.disabled = false; }
    };
   
  </script>
</body>

</html>