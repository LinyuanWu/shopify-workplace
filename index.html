<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Secure Checkout - Worldpay Bridge</title>
  <style>
    body { font-family: -apple-system, sans-serif; background-color: #f6f6f7; padding: 20px; color: #202223; }
    .checkout-container { background: #fff; max-width: 480px; margin: 20px auto; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
    h1 { font-size: 22px; text-align: center; margin-bottom: 25px; }
    .order-summary { background: #fbfcfd; border: 1px solid #dfe3e8; padding: 15px; border-radius: 8px; margin-bottom: 25px; text-align: center; }
    .amount { font-size: 26px; font-weight: bold; color: #008060; margin-top: 5px; }
    label { display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500; }
    input, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #babfc3; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
    button { width: 100%; padding: 16px; background: #000; color: #fff; border: none; border-radius: 6px; font-weight: bold; font-size: 17px; cursor: pointer; transition: background 0.2s; }
    button:hover { background: #333; }
    button:disabled { background: #999; cursor: not-allowed; }
    .error-msg { color: #d72c0d; font-size: 13px; margin-top: -10px; margin-bottom: 10px; display: none; }
  </style>
</head>
<body>

<div class="checkout-container">
  <h1>Secure Checkout</h1>
  
  <div class="order-summary">
    <p style="margin:0; color:#6d7175;">Total to Pay</p>
    <div id="total-amount" class="amount">Loading...</div>
  </div>

  <form id="payment-form">
    <label>Email Address</label>
    <input type="email" id="email" required placeholder="email@example.com">
    
    <div style="display:flex; gap:12px;">
      <div style="flex:1;">
        <label>First Name</label>
        <input type="text" id="fname" required>
      </div>
      <div style="flex:1;">
        <label>Last Name</label>
        <input type="text" id="lname" required>
      </div>
    </div>

    <label>Shipping Address</label>
    <input type="text" id="address" required placeholder="Full street address">

    <label>Select Payment Method</label>
    <select id="gateway">
      <option value="paypay">PayPay (JPY)</option>
      <option value="kakaopay">KakaoPay (KRW)</option>
      <option value="alipaycn">AlipayCN (CNY)</option>
      <option value="tosspay">Toss Pay (KRW)</option>
      <option value="naverpay">Naver Pay (KRW)</option>
    </select>

    <div id="error-box" class="error-msg"></div>
    <button type="submit" id="submit-btn">PAY NOW</button>
  </form>
</div>

<script>
  let currentCart = null;

  // 1. 初始化：抓取购物车数据
  async function initCheckout() {
    try {
      const res = await fetch('/cart.js');
      currentCart = await res.json();
      
      if (currentCart.item_count === 0) {
        document.getElementById('total-amount').innerText = "Empty Cart";
        document.getElementById('submit-btn').disabled = true;
        return;
      }

      const total = (currentCart.total_price / 100).toFixed(2);
      document.getElementById('total-amount').innerText = total + " " + currentCart.currency;
    } catch (err) {
      console.error("Cart Load Error", err);
      document.getElementById('total-amount').innerText = "System Error";
    }
  }

  initCheckout();

  // 2. 表单提交逻辑：调用 Worker API
  document.getElementById('payment-form').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submit-btn');
    const errBox = document.getElementById('error-box');
    
    btn.innerText = "Connecting to Bank...";
    btn.disabled = true;
    errBox.style.display = 'none';

    // 构造发送给 Worker 的数据包
    const payload = {
      order_id: "SH-" + Date.now(), // 生成临时流水号
      total_amount: (currentCart.total_price / 100).toFixed(2),
      currency: currentCart.currency,
      gateway_mask: document.getElementById('gateway').value,
      origin_domain: window.location.host, // 自动获取当前商店域名 (如 shop-a.myshopify.com)
      return_url: window.location.origin + "/pages/thank-you",
      hook_url: "https://test-pay.defitopay.com/api/v2/an/status-update", // 改为你的回传地址
      billing: {
        email: document.getElementById('email').value,
        first_name: document.getElementById('fname').value,
        last_name: document.getElementById('lname').value,
        address1: document.getElementById('address').value,
        city: "DefaultCity", // 后续可根据需要增加输入框
        zip: "0000",
        country: "JP"
      }
    };

    try {
      // 发送请求到 Cloudflare Worker API
      const response = await fetch('https://test-pay.defitopay.com/v1/an/checkout', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'worldpay_public_key': 'MIIBIjANBgkqhkiG9w0BAQEFDDFQ8AMIIBCgKCAQEAoDOXmpSAYzSDF3Ju+aEHZmRRvNWD6CCCwuULQmdGJgoJjWWxbmaA',
          'cus_secret_key': 'MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDH/z2Jtjdc47LBmuxRKNhllCPAFlpB4HhinEy0TgEKTeBZ+6qVBk2c1hbjUaXQwdgDwQ4S0J'
        },
        body: JSON.stringify(payload)
      });

      const result = await response.json();

      if (result.pay_url) {
        // 关键：由于在 Proxy 模式下，必须使用 window.top 才能跳出 Shopify 的框架
        window.top.location.href = result.pay_url;
      } else {
        throw new Error(result.message || "Payment Gateway Rejected");
      }
    } catch (err) {
      console.error("Worker API Error:", err);
      errBox.innerText = "Error: " + err.message;
      errBox.style.display = 'block';
      btn.innerText = "PAY NOW";
      btn.disabled = false;
    }
  };
</script>

</body>
</html>
