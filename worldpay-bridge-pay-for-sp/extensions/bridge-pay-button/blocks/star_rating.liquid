{% comment %} 
  Version 42.0 - 修复产品页按钮对齐（宽度溢出）问题，保持侧边栏上下排列逻辑
{% endcomment %}

<!-- 1. 静态按钮：修复宽度对齐问题 -->
{% if block.settings.show_at_position %}
<div class="bridge-pay-static-box" style="margin: 20px 0; width: 100%; box-sizing: border-box;">
  <button class="bridge-checkout-trigger-btn" style="
    background-color: {{ block.settings.btn_color }}; 
    color: #fff; 
    width: 100%; 
    max-width: 100%; /* 确保不超出父级 */
    padding: 15px; 
    border: none; 
    border-radius: 4px; 
    font-weight: bold; 
    cursor: pointer; 
    font-size: 16px; 
    display: block;
    box-sizing: border-box !important; /* 关键：确保 padding 不增加按钮总宽度 */
    margin: 0 auto;
    line-height: 1.5;
  ">
    {{ block.settings.btn_text }}
  </button>
</div>
{% endif %}

<script>
(function() {
  const btnText = '{{ block.settings.btn_text }}';
  const btnColor = '{{ block.settings.btn_color }}';
  const hideNative = {% if block.settings.hide_native %}true{% else %}false{% endif %};

  async function startCheckout(e) {
    e.preventDefault();
    const targetBtn = e.target;
    targetBtn.innerText = 'Processing...';
    targetBtn.disabled = true;

    try {
      const variantId = document.querySelector('form[action*="/cart/add"] [name="id"]')?.value 
                     || document.querySelector('[name="id"]')?.value;
      const quantity = document.querySelector('[name="quantity"]')?.value || 1;

      if (variantId && !isNaN(variantId)) {
        await fetch(window.Shopify.routes.root + 'cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: [{ id: parseInt(variantId), quantity: parseInt(quantity) }] })
        });
        await new Promise(r => setTimeout(r, 400));
      }
      window.location.href = window.Shopify.routes.root + 'apps/safe-pay';
    } catch (err) {
      window.location.href = window.Shopify.routes.root + 'apps/safe-pay';
    }
  }

  // A. 静态按钮点击监听
  document.addEventListener('click', function(e) {
    if (e.target && e.target.classList.contains('bridge-checkout-trigger-btn')) {
      startCheckout(e);
    }
  });

  // B. 侧边栏动态注入（保持 V41 成功的上下排版）
  function handleDrawer() {
    const nativeBtn = document.querySelector('button[name="checkout"], .cart__checkout-button, #checkout');
    if (!nativeBtn) return;

    if (!document.getElementById('unique-bridge-drawer-btn')) {
      const bridgeBtn = document.createElement('button');
      bridgeBtn.id = 'unique-bridge-drawer-btn';
      bridgeBtn.innerText = btnText;
      bridgeBtn.type = 'button';
      
      bridgeBtn.style.cssText = `
        background-color: ${btnColor} !important;
        color: #fff !important; 
        width: 100% !important; 
        margin-bottom: 12px !important;
        padding: 16px !important; 
        border: none !important; 
        border-radius: 4px !important;
        font-weight: bold !important; 
        cursor: pointer !important; 
        font-size: 16px !important; 
        display: block !important;
        box-sizing: border-box !important;
      `;
      
      bridgeBtn.onclick = startCheckout;
      nativeBtn.parentNode.insertBefore(bridgeBtn, nativeBtn);

      if (hideNative) {
        nativeBtn.style.setProperty('display', 'none', 'important');
      } else {
        nativeBtn.style.display = '';
      }
    }
  }

  const observer = new MutationObserver(handleDrawer);
  observer.observe(document.body, { childList: true, subtree: true });
})();
</script>

{% schema %}
{
  "name": "Bridge Pay Button",
  "target": "section",
  "settings": [
    { "type": "text", "id": "btn_text", "label": "Button Text", "default": "SECURE CHECKOUT (WORLDPAY)" },
    { "type": "color", "id": "btn_color", "label": "Button Color", "default": "#000000" },
    { "type": "checkbox", "id": "hide_native", "label": "Hide Native Checkout Button", "default": false },
    { "type": "checkbox", "id": "show_at_position", "label": "Show Button at this location", "default": true }
  ]
}
{% endschema %}