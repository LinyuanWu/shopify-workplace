{% comment %} 
  自定义截流结账按钮逻辑 
{% endcomment %}

<div class="bridge-pay-container" style="margin: 20px 0;">
  <button id="bridge-checkout-btn" style="
    background-color: {{ block.settings.btn_color }}; 
    color: #fff; 
    width: 100%; 
    padding: 15px; 
    border: none; 
    border-radius: 4px; 
    font-weight: bold; 
    cursor: pointer;
    font-size: 16px;
  ">
    {{ block.settings.btn_text }}
  </button>
</div>

<script>
document.getElementById('bridge-checkout-btn').addEventListener('click', async function(e) {
  e.preventDefault();
  const btn = this;
  btn.innerText = 'Redirecting...';
  btn.style.opacity = '0.7';

  try {
    // 1. 检查购物车是否有货
    const cartRes = await fetch(window.Shopify.routes.root + 'cart.js');
    const cart = await cartRes.json();

    if (cart.item_count === 0) {
      alert("Your cart is empty!");
      btn.innerText = '{{ block.settings.btn_text }}';
      btn.style.opacity = '1';
      return;
    }

    // 2. 跳转到 App Proxy 路径
    // 逻辑：跳转到 /apps/safe-pay，我们的 App 会在那里渲染结账单
    // 修改这一行：不要在当前窗口跳转，改用 open 打开新窗口
    // window.location.href = window.Shopify.routes.root + 'apps/safe-pay';
    
    // 替换为：
    const checkoutUrl = window.location.origin + window.Shopify.routes.root + 'apps/safe-pay';
    window.open(checkoutUrl, '_blank');
    
  } catch (err) {
    console.error('Checkout error:', err);
    alert("System error, please try again.");
    btn.innerText = '{{ block.settings.btn_text }}';
  }
});
</script>

{% schema %}
{
  "name": "Bridge Pay Button",
  "target": "section",
  "settings": [
    { "type": "text", "id": "btn_text", "label": "Button Text", "default": "SECURE CHECKOUT (WORLDPAY)" },
    { "type": "color", "id": "btn_color", "label": "Button Color", "default": "#000000" }
  ]
}
{% endschema %}