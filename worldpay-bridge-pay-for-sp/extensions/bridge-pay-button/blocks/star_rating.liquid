{% comment %} 
  自定义截流结账按钮逻辑 
{% endcomment %}

<div class="bridge-pay-container" style="margin: 20px 0;">
  <button id="bridge-checkout-btn" style="
    background-color: {{ block.settings.btn_color }}; 
    color: #fff; 
    width: 100%; 
    padding: 15px; 
    border: none; 
    border-radius: 4px; 
    font-weight: bold; 
    cursor: pointer;
    font-size: 16px;
  ">
    {{ block.settings.btn_text }}
  </button>
</div>

<script>
document.getElementById('bridge-checkout-btn').addEventListener('click', async function(e) {
  e.preventDefault();
  const btn = this;
  
  btn.innerText = 'Processing...';
  btn.style.opacity = '0.7';
  btn.disabled = true;

  try {
    // 1. 抓取当前页面可能存在的变体 ID 和 数量
    const variantId = document.querySelector('form[action*="/cart/add"] [name="id"]')?.value 
                   || document.querySelector('[name="id"]')?.value;
    const quantity = document.querySelector('[name="quantity"]')?.value || 1;

    // 2. 如果在产品页，执行异步加车逻辑
    if (variantId && !isNaN(variantId)) {
      await fetch(window.Shopify.routes.root + 'cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          items: [{
            id: parseInt(variantId),
            quantity: parseInt(quantity)
          }]
        })
      });
      // 稍微等待 300 毫秒，确保 Shopify 服务器完成 Session 更新
      await new Promise(resolve => setTimeout(resolve, 300));
    }

    // 3. 【核心修复】不再拦截空购物车，直接强制跳转
    // 如果刚才加车成功了，购物车一定有货；如果本来就有货，更没问题。
    window.location.href = window.Shopify.routes.root + 'apps/safe-pay';
    
  } catch (err) {
    console.error('Checkout Error:', err);
    // 即使出错也强制尝试跳转
    window.location.href = window.Shopify.routes.root + 'apps/safe-pay';
  }
});
</script>

{% schema %}
{
  "name": "Bridge Pay Button",
  "target": "section",
  "settings": [
    { "type": "text", "id": "btn_text", "label": "Button Text", "default": "SECURE CHECKOUT (WORLDPAY)" },
    { "type": "color", "id": "btn_color", "label": "Button Color", "default": "#000000" }
  ]
}
{% endschema %}
