{% comment %} 
  自定义截流结账按钮逻辑 
{% endcomment %}

<div class="bridge-pay-container" style="margin: 20px 0;">
  <button id="bridge-checkout-btn" style="
    background-color: {{ block.settings.btn_color }}; 
    color: #fff; 
    width: 100%; 
    padding: 15px; 
    border: none; 
    border-radius: 4px; 
    font-weight: bold; 
    cursor: pointer;
    font-size: 16px;
  ">
    {{ block.settings.btn_text }}
  </button>
</div>

<script>
document.getElementById('bridge-checkout-btn').addEventListener('click', async function(e) {
  e.preventDefault();
  const btn = this;
  const originalText = btn.innerText;
  
  btn.innerText = 'Processing...';
  btn.style.opacity = '0.7';
  btn.disabled = true;

  try {
    // 1. 【核心逻辑】判断是否在产品页并抓取当前选中的变体
    // Shopify 标准主题中，选中的 Variant ID 通常存在名为 "id" 的 input 中
    // 数量通常存在名为 "quantity" 的 input 中
    const variantId = document.querySelector('form[action*="/cart/add"] [name="id"]')?.value 
                   || document.querySelector('[name="id"]')?.value;
    const quantity = document.querySelector('[name="quantity"]')?.value || 1;

    // 2. 如果找到了变体 ID，说明在产品页，先执行“加入购物车”动作
    if (variantId && !isNaN(variantId)) {
      console.log('检测到产品页，正在加车 Variant ID:', variantId);
      await fetch(window.Shopify.routes.root + 'cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          items: [{
            id: parseInt(variantId),
            quantity: parseInt(quantity)
          }]
        })
      });
    }

    // 3. 跳转到我们的自定义代理结账页
    // 此时购物车已经包含了刚才加进去的产品
    window.location.href = window.Shopify.routes.root + 'apps/safe-pay';
    
  } catch (err) {
    console.error('Checkout Redirect Error:', err);
    // 即使加车报错，也尝试跳转（可能购物车里已经有东西了）
    window.location.href = window.Shopify.routes.root + 'apps/safe-pay';
  }
});
</script>

{% schema %}
{
  "name": "Bridge Pay Button",
  "target": "section",
  "settings": [
    { "type": "text", "id": "btn_text", "label": "Button Text", "default": "SECURE CHECKOUT (WORLDPAY)" },
    { "type": "color", "id": "btn_color", "label": "Button Color", "default": "#000000" }
  ]
}
{% endschema %}
